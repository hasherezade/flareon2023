# Coppersmith Stereotyped Message Recovery
# Using Sage Math

# Copyright 2021-2022 Maxim Masiutin
# This file may be distributed on conditions of the
# GNU General Public License v3.0

# it implements the following function: message_recover
# to decrypt a "secret" from the message (m) consisting of "prefix | secret | suffix"
# if we only know "prefix" and "suffix" but not the "secret"
# inputs: prefix, sec_len (length of the secret in bytes), suffix, c, n, e
# where "n" and "e" are parts of RSA public key, and "c" is the ciphertext
# output: message (m) consisting of "prefix | secret | suffix"
# (prefix and suffix are of bytearray types, whereas c, n and e are integers)

# to install rerequisites, run
# sage -pip install pycryptodome pycrypto

from Crypto.Util.number import long_to_bytes, bytes_to_long


def message_recover(prefix, sec_len, suffix, c, n, e):
    ZmodN = Zmod(n)
    P.<x> = PolynomialRing(ZmodN)
    suffix_len = len(suffix)
    a = ZmodN(
        (bytes_to_long(prefix) * (2 ^ ((sec_len + suffix_len) * 8)))
        + bytes_to_long(suffix)
    )
    b = ZmodN(Integer(2 ^ (suffix_len * 8)))
    c = ZmodN(c)
    f = (a + b * x) ^ e - c
    f = f.monic()
    roots = f.small_roots(epsilon=1 / 20)
    rc = len(roots)
    if rc == 0:
        return None
    elif rc == 1:
        message = a + b * (roots[0])
        return long_to_bytes(int(message))
    else:
        print(
            "Don't know how to handle situation when multiple roots are returned:", rc
        )
        sys.exit(1)


def encrypt(m, n, e):
    m = bytes_to_long(m)
    return pow(m, e, n)


def demo(
    n=None,
    bits=None,
    e=None,
    c=None,
    prefix=None,
    suffix=None,
    test_secret=None,
    secret_len=None,
):
    if "n" not in locals() or n is None:
        print("Generating public modulus..")
        if "bits" not in locals() or bits is None:
            bits = 4096
        pn = 2 ^ (bits // 2) - 1
        pl = 2 ^ (bits // 2 - 1)
        p = random_prime(pn, False, pl)
        q = random_prime(pn, False, pl)
        n = p * q
        print("n=", n)
    else:
        if not ("bits" not in locals() or bits is None):
            print(
                'Error: if you defined "n"', n, 'you should not specify "bits"!', bits
            )
            sys.exit(1)

    if "e" not in locals() or e is None:
        e = 5
        print("e=", e)

    if "suffix" not in locals() or suffix is None:
        suffix = (
            bytearray([0x0A])
            + "The quick brown fox jumped over ??".encode()
            + bytearray([0x0A])
        )

    if "prefix" not in locals() or prefix is None:
        prefix = "Alice was beginning to get very tired of sitting by her sister on the bank, and of having nothing to do once or twice she had peeped into sister was reading, but it had no pictures or conversations in it, and what is the use of a book thought Alice without".encode() + bytearray(
            [0xE8, 0x01]
        )

    if "c" not in locals() or c is None:
        if "test_secret" not in locals() or test_secret is None:
            if "secret_len" not in locals() or secret_len is None:
                secret_len = 51
            test_secret = (bytearray([0xFF])) * int(
                secret_len
            )  # You can also fill this with pseudorandom bytes rather than fixed bytes
        else:
            secret_len = len(test_secret)

        plaintext = prefix + test_secret + suffix
        c = encrypt(plaintext, n, e)
        print("c=", c)
    else:
        if "secret_len" not in locals() or secret_len is None:
            secret_len = 51

    e = Integer(e)
    n = Integer(n)
    c = Integer(c)
    max_secret_len = max(n.nbits(), c.nbits()) // 8 - len(prefix) - len(suffix)
    if secret_len > max_secret_len:
        print(
            "Error: The secret length of",
            secret_len,
            "byte(s) is larger then the maximum of",
            max_secret_len,
            "bytes(s) for the given prefix, suffix, encrypted message and the public exponent!",
        )
        sys.exit(1)

    print(
        "Will recover the secret with the length of up to a maximum",
        max_secret_len,
        "byte(s).",
    )

    # Attack
    while True:
        print("Trying to recover the message", secret_len, "byte(s) long...")
        message = message_recover(prefix, secret_len, suffix, c, n, e)
        if message is not None:
            # Uncomment the following if you need to write decrypted message on disk
            #            with open("decrypted-message.bin", "wb") as file:
            #                file.write(message)
            #                file.close()
            break
        else:
            if secret_len > max_secret_len:
                print("Could not recover the message, sorry!")
                sys.exit(1)
        secret_len += 1

    # Result
    print("Decrypted message:", message)
    if ("plaintext" in locals()) and (plaintext is not None) and (plaintext != message):
        print("Original message:", plaintext)


def test():
    demo(
        prefix='Alice was beginning to get very tired of sitting by her sister on the bank, and of having nothing to do: once or twice she had peeped into the book her sister was reading, but it had no pictures or conversations in it, "and what is the use of a book," thought Alice "without pictures or conversations?"'.encode(),
        suffix="So she was considering in her own mind".encode(),
        secret_len=40,
        n=3467426486679248188653108800559303386287554758768603423122467027096467860515830623551961505313664141296904641850703744135287017025760835972810054078803098293940120479477368194541115344412791785116997727196022631723141878728286774255685156516571932296886998466272454887539602731047343742495050002572671441193084923555233670458750289683414636469156422984229794884454599364548820051674964597550868314576555780472229387306932641830261590611187094400404466606122448216261863751961471245387850997613367062927316452286763923670194071565360870710022155335514833711527379119373273785777917295893791807847357955717062357902040066841760808578372256972697775905378757195955033469778059624315778200977783278536951525075875817778053895771050091363086812118962820826913609223645211122676803341948235209417823538105756118234896445613991053915093869273988913032068314497103454497121342138262082883895648291665445774240369766951426339216224501,
        c=1645498320791922355370582405240330238181898362355669999154282619303555388816710519302334630489599513620176476760170863786912237609212103154819355284178634755973253089665511013478752584901123440508521746236195297468216467660585016981530193945296058601498154741758745039290985367949310875873967601907643217262326981812819079068959387615487967414671214032971663472966158431796224181094930097892861707149276839212476062372980863751941436630964414322278441114208206128295171964575548674651941040698297767917766445273137044493894256068224643110590026278922448779703119830564462762258074089349992877098014295551671411309753998809139826159064187372041128390000943466532405817925849618091490918009815597145386320673834140074030363821605804064759459481999821411660750101044308020947066515938666198128830019734714713943695606835860234200477950674896538820361444367838869357004264378083620039955731589936285249148617818041606353949565615,
        e=3,
    )


# Uncomment the demos below

#    demo(
#        n=620415350359517741356680529322667460342248495071186305976261684335672809870098750647238414822821044030537691082177056952561129641116363556775512914986667592370683092181837969854424602776439927749666706104586718466670341409464495622306109300030270137061895529274021105315808830799307733136314483489434571024720159966766579133154790854211789305680279496158901386312244462742713069070128311114853696711903489231366072896536971710860165273294931944220877351993260396436117157801211169453891785546041915094345109800438515975538448642673156909122018395471033764873127746748654243575259316633233153060089372753109850242407735236338536633286090507649753300801929232675393099186554178712331794317069763122512495051548874644101076154591568887626726530340988206193467459299359941324511195483143416163026469782549417703318747187080596527488232580794531363165428785775933148969244974384001303805002416690551140439347455944606247368400626822637768316700327376254486243558743180810134599493404763694905162631067294911790558238809841728346668048281636100178117908601802364348228276629363125725567659393607905631883466770579226919850705051277245064045618032721935908082008684436214010900437524607981463111977147909754711383211746670352202427992005473264733078703367295391413596436289946561927431941032684664047374529560292764427937745305781801833731544000903068948773463110765468943937245012712152254861011152858809967642757991332801666709871057073062096298003810812555288387313682266071762906522112543868417522328077751344554008120304999373475166271612109568260058499260063490072135229041674737968869623803714703070660649670935141007381188277029638062117658811420669300378924440906322065349051900549759130824730697247049537640244005799871040924358868711923195594508105931167426661751662721078915458438073027174018307380235717648984900145154584916432612105969286240251377065988910675069523523662228468270760309746206823322662270679762928653722907967626956555907266366332825209859055907499299486194621958690618689343845795800460063538929731441132530348275255693251299307616760905655909289582717314617176795066500870868075259057406287817632648007614798088978407363647266982415558371887690763672442073397761756388055093404987992246048481670574960837010186916632493954329123314861921494113103879589769411286300662276121569803425569371689786539227203643037293975608145884196613171822868975085179235932512599531646771804956538651857174023218753449442831752920589834496828669970622639226517,
#        e=5,
#        c=457158955720606700274411441459482854982227362534831145609052185748990631109214954142124229054236710145368068322105854288483150249203009239145580614595826523558057049192542489253736971554446534213294218135217755979357637275376076982307135672116502978286998255869700516905383002022676981569445977386154846226852248847750814620817111822533134563280394946858407051983262573962681164106034695004657750807174189470698157765290699354678786910014352687511335150699257938577115570201281611134692144855981812572071351061818076958681428446152887069702675734018520858132797241753996607649792848616443458441533616305117470811971594326621494508587233426413677658649231661618082050988188909494246266458377799558367841877205122416764798651645348711625408480393150752594021175743609216424698762051509891829038325261051691884453489640979708492507151289378113105713732096908891700754818144064042731812273011941669874029104929553887100432798151998659068142488056142761309986214011772035332140977713987296612884970377826747318969280241440948439559666377115650637945328197224207232281487324371746286821536281442946518072146988156539093141132704599430537194915132233140159757059250499879063565086279889005890936539943281330119008308967753480365081503059800241144540948385233083763854615899645710030484018331486379249772819596961705261005154553413720039890649104890741797586962487125163720845256616135182650061295097400803924605393513039200206774400525374116279712014405494686688153091966776365844755524774207361485210249797605969401353952163770079644190179553078938157284806588748242644911331146467413407085953046050664945522281858715099768225161812011290431301365241884613227745107172664373283053183186740039315119067974419308384213960274223615821695054972800225664288173442193732470637103548099869490690844909114911672343791538170272103165498848194722466927909851416929598203457693734065796949775599060894340928688683291120257305969740848326383418224514523901555333165263945140124131369868367034980404764071471097108999102190887844023076423566235732129086493889746264619554514226135233481092283781127589991711011917774452534994569423582508992782931467415925290766015887860703459459708290314715561725414460740807245178609960596838247771218060036978417835163020628148336265372147322422531407671601335340975432875108282932673002580730236147616964962658205085765240142277103981418988034428105449650485474731232419608768522037263396397872186655733676163409951064892600924594257204878872057381,
#        secret_len=51
#        )

#    demo(
#         test_secret = 'to find where Doctor Fred is holding the tentacles!'.encode()
#         )

#    demo(
#         bits=2560,
#         secret_len=22,
#         e=3
#         )


if __name__ == "__main__":
    test()
